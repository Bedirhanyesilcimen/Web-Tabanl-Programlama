@model List<WorkFlowApp.Models.MamulStok>
@{ 
    ViewData["Title"] = "Mamul Stok"; 
    var secilenTarih = (DateTime)ViewBag.SecilenTarih;
    bool isGM = User.IsInRole("GenelMudur");
}

<div class="container-fluid mt-3">
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body py-3">
            <div class="row align-items-center g-3">
                <div class="col-md-3">
                    <h3 class="text-dark fw-bold mb-0"><i class="fas fa-boxes"></i> Mamul Bölümü</h3>
                </div>

                <div class="col-md-5 d-flex justify-content-center">
                    <form action="/Depo/Mamul" method="get" class="d-flex align-items-center gap-2 bg-light p-2 rounded border">
                        <input type="date" name="tarih" class="form-control form-control-sm" value="@secilenTarih.ToString("yyyy-MM-dd")" onchange="this.form.submit()">
                    </form>
                </div>

                <div class="col-md-4 d-flex justify-content-end">
                    @if (!isGM) {
                        <form action="/Depo/MamulExcelYukle" method="post" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                            <button class="btn btn-sm btn-success fw-bold">LİSTE YÜKLE</button>
                        </form>
                    }
                </div>
                <div class="d-flex justify-content-end mb-3">
                  @if (!User.IsInRole("GenelMudur"))
                    {
                      <form action="/Depo/MamulExcelYukle" method="post" enctype="multipart/form-data" class="d-flex gap-2">
                     <input type="file" name="excelDosyasi" class="form-control form-control-sm" required>
                <button class="btn btn-sm btn-success fw-bold text-nowrap">EXCEL YÜKLE</button>
                     </form>
                     }
                     </div>
                
                <div class="col-12 d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                    <input type="text" id="mamulSearch" class="form-control form-control-sm w-50" placeholder="Mamul ürün ara..." onkeyup="tabloFiltrele('mamulSearch')">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="zeroToggle" onchange="toggleZeroRows()">
                        <label class="form-check-label small fw-bold" for="zeroToggle">Sıfırları Gizle</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="mamulTable">@await Html.PartialAsync("_MamulTablosu", Model)</div>
</div>

<script>
    function tabloFiltrele(inputId) {
        var filter = document.getElementById(inputId).value.toUpperCase();
        document.querySelectorAll("table tbody tr").forEach(row => {
            row.style.display = row.innerText.toUpperCase().includes(filter) ? "" : "none";
        });
    }

    function toggleZeroRows() {
        var isHidden = document.getElementById("zeroToggle").checked;
        document.querySelectorAll("table tbody tr").forEach(row => {
            var cells = row.getElementsByTagName("td");
            if (cells.length > 1) {
                var amount = parseFloat(cells[cells.length - 1].innerText.replace(/,/g, '').trim());
                if (amount === 0) row.style.display = isHidden ? "none" : "";
            }
        });
    }

    function mamulGuncelle(input, id, alan) {
        if ("@isGM" === "True") { alert("Yetkiniz yok!"); input.value = input.defaultValue; return; }
    }
</script>
